name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  checks:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.11"]
    env:
      POETRY_VIRTUALENVS_IN_PROJECT: "true"
    steps:
      - name: Initialize timing table
        run: |
          start=$(date +%s)
          echo "JOB_START=$start" >> "$GITHUB_ENV"
          echo "LAST_TIME=$start" >> "$GITHUB_ENV"
          {
            echo "## CI Stage Timings"
            echo ""
            echo "| Stage | Duration (s) |"
            echo "| --- | --- |"
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/checkout@v4
      - name: Log checkout duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Checkout duration: %ss\n' "$duration"
          printf '| Checkout | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Log setup-python duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Setup Python duration: %ss\n' "$duration"
          printf '| Setup Python | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Cache Poetry virtualenv
        id: poetry-cache
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-
      - name: Log poetry cache duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Poetry cache duration: %ss\n' "$duration"
          printf '| Poetry Cache | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Cache pip wheels
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('poetry.lock') }}
          restore-keys: |
            pip-${{ runner.os }}-
      - name: Log pip cache duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Pip cache duration: %ss\n' "$duration"
          printf '| Pip Cache | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Install pre-commit and poetry
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit poetry
      - name: Log tool installation duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Tool install duration: %ss\n' "$duration"
          printf '| Install Tools | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Run pre-commit
        run: pre-commit run --all-files
      - name: Log pre-commit duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Pre-commit duration: %ss\n' "$duration"
          printf '| Pre-commit | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Install project
        run: poetry install
      - name: Log install duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Project install duration: %ss\n' "$duration"
          printf '| Poetry Install | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Run pytest with coverage
        run: poetry run pytest --cov=data_needs_reporter --cov-report=xml --cov-report=term
      - name: Log pytest duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Pytest duration: %ss\n' "$duration"
          printf '| Pytest | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-${{ matrix.python-version }}
          path: coverage.xml
      - name: Log coverage upload duration
        run: |
          now=$(date +%s)
          duration=$((now - LAST_TIME))
          printf 'Coverage upload duration: %ss\n' "$duration"
          printf '| Coverage Upload | %s |\n' "$duration" >> "$GITHUB_STEP_SUMMARY"
          echo "LAST_TIME=$now" >> "$GITHUB_ENV"
      - name: Log total job duration
        if: always()
        run: |
          now=$(date +%s)
          total=$((now - JOB_START))
          printf 'Total job duration: %ss\n' "$total"
          printf '| Overall | %s |\n' "$total" >> "$GITHUB_STEP_SUMMARY"

  benchmarks:
    needs: checks
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      POETRY_VIRTUALENVS_IN_PROJECT: "true"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install poetry
      - name: Install project
        run: poetry install
      - name: Run bench script
        id: run-bench
        run: |
          set +e
          poetry run python scripts/bench.py --report-format json --report-file bench.json
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
      - name: Show bench output
        if: always()
        run: |
          if [[ -f bench.json ]]; then
            cat bench.json
          else
            echo "bench.json missing"
          fi
      - name: Summarize benchmarks
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          summary_path = Path("bench.json")
          if not summary_path.exists():
              print("bench.json not found; skipping summary")
              raise SystemExit(0)

          payload = json.loads(summary_path.read_text(encoding="utf-8"))
          lines = [
              "## Benchmark Budget Check",
              "",
              "| Command | Seconds | Target | Peak RSS (MB) | Status |",
              "| --- | --- | --- | --- | --- |",
          ]
          for cmd in payload.get("commands", []):
              rss = cmd.get("peak_rss_mb")
              rss_display = f"{rss:.1f}" if isinstance(rss, (int, float)) else "n/a"
              status = "ok" if cmd.get("within_budget") else ("slow" if cmd.get("exit_code") == 0 else "fail")
              lines.append(
                  f"| {cmd.get('name')} | {cmd.get('elapsed_s', 0.0):.2f} | "
                  f"{cmd.get('target_s', 0.0):.2f} | {rss_display} | {status} |"
              )
          lines.append("")
          lines.append(f"All commands within budget: {payload.get('all_within_budget')}")

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as fh:
              fh.write("\n".join(lines) + "\n")
          PY
